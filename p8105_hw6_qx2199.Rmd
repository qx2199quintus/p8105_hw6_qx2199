---
title: "P8105_HW#6_qx2199"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
set.seed(1)
```

```{r load_libraries}
library(tidyverse)
library(modelr)
library(p8105.datasets)
```

### Problem 1

```{r}
homicide_df = 
  read_csv("./homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1)
  ) %>% 
  filter(
    victim_race %in% c("White", "Black"),
    city_state != "Tulsa, AL") %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```


Start with one city.

```{r}
baltimore_df =
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")
glm(resolution ~ victim_age + victim_race + victim_sex, 
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```


Try this across cities.

```{r}
models_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, term, OR, starts_with("CI")) 
```

```{r}
models_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```



## Problem 2



```{r}
baby_df = read_csv("./birthweight.csv") %>% 
 janitor::clean_names() %>% 
  mutate(
    babysex = case_when(
      babysex == "1" ~ "male",
      babysex == "2" ~ "female",
      TRUE ~ as.character(babysex)
    ),
    frace = case_when(
      frace == "1" ~ "white",
      frace == "2" ~ "black",
      frace == "3" ~ "Asian",
      frace == "4" ~ "Puerto Rican",
      frace == "8" ~ "Other",
      frace == "9" ~ "Unknown",
      TRUE ~ as.character(frace)
    ),
     mrace = case_when(
      mrace == "1" ~ "white",
      mrace == "2" ~ "black",
      mrace == "3" ~ "Asian",
      mrace == "4" ~ "Puerto Rican",
      mrace == "8" ~ "Other",
      mrace == "9" ~ "Unknown",
      TRUE ~ as.character(mrace)
      ),
    malform = case_when(
      malform == "0" ~ "absent",
      malform == "1" ~ "present",
      TRUE ~ as.character(malform)
       ))

baby_df %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    mrace = as.factor(mrace),
    malform = as.factor(malform)
    
  )
baby_df %>% 
  anyNA()

```

The birthweight data contains `r baby_df %>% nrow()` rows, `r baby_df %>% ncol()` columns, and no missing data. 

###fit a model

Given that pre-pregnancy bmi was calculated by pre-pregnancy height and pre-pregnancy weight, which indicates that these three variables are highly correlated. Therefore, we exclude mheight and ppwt.Also, wtgain was calculated by delwt and ppwt, we could hence exclude delwt. ?????
fit model: 
```{r}
model_build_one = lm(bwt ~ babysex + bhead + blength + fincome + frace + gaweeks + malform + menarche  + momage + mrace + parity + pnumlbw + pnumsga+ ppbmi + smoken + wtgain,  data = baby_df)

model_build_one %>% 
broom::tidy() %>% 
select(term, estimate, p.value) %>% 
knitr::kable(digits = 4)
```
Given that pre-pregnancy bmi was calculated by pre-pregnancy height and pre-pregnancy weight, which indicates that they are highly correlated. Therefore, we exclude mheight and ppwt.  Also, wtgain was calculated by delwt and ppwt, we could hence remove ppwt. 
from the output, we could see that the variables that we want to include in our model are: `babysex`  `bhead`  `blength` `fincome`  `gaweeks`   `parity` `ppbmi` ` smoken`  `wtgain`


```{r}
model_fit = lm(bwt ~ babysex + bhead + blength + fincome + gaweeks + parity + ppbmi + smoken + wtgain, data = baby_df) 
```


```{r}
  baby_df %>% 
  add_residuals(model_fit) %>% 
  add_predictions(model_fit) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.5) +
  labs( title = "Residuals against Fitted Values", x = "Fitted Value", y = "Residuals"
  )
```


#####One using length at birth and gestational age as predictors (main effects only)


```{r}


cross_validation = 
  crossv_mc(baby_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)) %>% 
  mutate(
    model_one = map(train, ~lm(bwt ~ babysex + bhead + blength + fincome + gaweeks + parity + ppbmi + smoken + wtgain, data = .x)),
    model_main = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    model_inter = map(train, ~lm(bwt ~ bhead * blength * babysex, data = .x))) %>% 
  mutate(
    rmse_one = map2_dbl(model_one, test, ~rmse(model = .x, data = .y)),
    rmse_main = map2_dbl(model_main, test, ~rmse(model = .x, data = .y)),
    rmse_inter = map2_dbl(model_inter, test, ~rmse(model = .x, data = .y)),
  )

rmse_plot = 
  cross_validation  %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse, fill = model)) +
  geom_violin(alpha = 0.5) +
  labs( title = "Cross Validation Comparisons", x = "Model", y = "RMSE")
   
rmse_plot

```
According to the average RMSE value and the violin plot, the my  model ( `babysex`+ `bhead`+ `blength`+ `fincome`+ `gaweeks`+`parity`+ `ppbmi`+ `smoken`+ `wtgain`) has the lowes residuals. Therefore, it's the best model among the three.The model with only main effects ( `blength` +`gaweeks` ) has the highest residual and hence is the worst one.The model with  length, sex, and all interactions the mig-level of residuals among the three models/ TTherefore, it's the second best model. 







